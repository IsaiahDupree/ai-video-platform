module.exports=[27890,e=>{"use strict";var t,r=e.i(47909),n=e.i(74017),i=e.i(96250),a=e.i(59756),s=e.i(61916),o=e.i(74677),c=e.i(69741),u=e.i(16795),d=e.i(87718),_=e.i(95169),l=e.i(47587),p=e.i(66012),E=e.i(70101),m=e.i(26937),v=e.i(10372),h=e.i(93695);e.i(52474);var S=e.i(220),R=e.i(89171),y=e.i(54799),f=((t={}).CUSTOMER_CREATED="customer.created",t.CUSTOMER_UPDATED="customer.updated",t.CUSTOMER_DELETED="customer.deleted",t.CUSTOMER_SUBSCRIPTION_CREATED="customer.subscription.created",t.CUSTOMER_SUBSCRIPTION_UPDATED="customer.subscription.updated",t.CUSTOMER_SUBSCRIPTION_DELETED="customer.subscription.deleted",t.CUSTOMER_SUBSCRIPTION_TRIAL_WILL_END="customer.subscription.trial_will_end",t.INVOICE_CREATED="invoice.created",t.INVOICE_FINALIZED="invoice.finalized",t.INVOICE_PAYMENT_SUCCEEDED="invoice.payment_succeeded",t.INVOICE_PAYMENT_FAILED="invoice.payment_failed",t.INVOICE_PAYMENT_ACTION_REQUIRED="invoice.payment_action_required",t.INVOICE_UPCOMING="invoice.upcoming",t.CHARGE_SUCCEEDED="charge.succeeded",t.CHARGE_FAILED="charge.failed",t.CHARGE_REFUNDED="charge.refunded",t.CHARGE_DISPUTE_CREATED="charge.dispute.created",t.PAYMENT_INTENT_SUCCEEDED="payment_intent.succeeded",t.PAYMENT_INTENT_PAYMENT_FAILED="payment_intent.payment_failed",t),g=e.i(45722);let b=(0,e.i(24389).createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL||"",process.env.SUPABASE_SERVICE_ROLE_KEY||"");async function C(e){await b.from("subscription_snapshots").update({is_current:!1}).eq("subscription_id",e.subscription_id).eq("is_current",!0);let{data:t,error:r}=await b.from("subscription_snapshots").insert({subscription_id:e.subscription_id,person_id:e.person_id,status:e.status,mrr_cents:e.mrr_cents,amount_cents:e.amount_cents,currency:e.currency,current_period_start:e.current_period_start,current_period_end:e.current_period_end,canceled_at:e.canceled_at,ended_at:e.ended_at,mrr_change_cents:e.mrr_change_cents,churn_status:e.churn_status||"active",churn_reason:e.churn_reason,snapshot_date:new Date().toISOString().split("T")[0],snapshot_period:"daily",is_current:!0}).select().single();if(r)throw Error(`Failed to create subscription snapshot: ${r.message}`);return t}async function w(e){let{data:t,error:r}=await b.from("subscription_snapshots").select("*").eq("subscription_id",e).eq("is_current",!0).single();if(r&&"PGRST116"===r.code)return null;if(r)throw Error(`Failed to get latest subscription snapshot: ${r.message}`);return t}async function I(e,t){let r,n=t?e.mrr_cents-t.mrr_cents:e.mrr_cents||0,i=t?.status,a="active";return i&&i!==e.status&&("active"===i&&["canceled","past_due","unpaid"].includes(e.status)?(a="churned",r="canceled"===e.status?"Subscription canceled":`Subscription status: ${e.status}`):["canceled","past_due","unpaid"].includes(i)&&"active"===e.status&&(a="reactivated",r="Subscription reactivated")),C({subscription_id:e.id,person_id:e.person_id,status:e.status,mrr_cents:e.mrr_cents||0,amount_cents:e.amount_cents,currency:e.currency,current_period_start:e.current_period_start,current_period_end:e.current_period_end,canceled_at:e.canceled_at,ended_at:e.ended_at,mrr_change_cents:n,churn_status:a,churn_reason:r})}async function T(e){try{var t;let r,n=function(e){let{type:t,data:r,id:n,created:i}=e;try{let e=r.object;if(t.startsWith("customer.subscription.")){var a;return{event_id:n,event_type:t,created_at:i,customer_id:e.customer,subscription_id:e.id,subscription_status:({trialing:"trialing",active:"active",past_due:"past_due",canceled:"canceled",unpaid:"unpaid",incomplete:"incomplete",incomplete_expired:"incomplete"})[e.status]||"active",currency:e.currency,plan_id:e.items.data[0]?.price?.product||"",interval:(a=e.items.data[0]?.price?.recurring?.interval||"month","year"===a?"year":"month"),amount_cents:e.items.data[0]?.price?.unit_amount||0,trial_start:e.trial_start?1e3*e.trial_start:void 0,trial_end:e.trial_end?1e3*e.trial_end:void 0,current_period_start:1e3*e.current_period_start,current_period_end:1e3*e.current_period_end,canceled_at:e.canceled_at?1e3*e.canceled_at:void 0,ended_at:e.ended_at?1e3*e.ended_at:void 0,object_type:"subscription"}}if(t.startsWith("customer."))return{event_id:n,event_type:t,created_at:i,customer_id:e.id,email:e.email||void 0,object_type:"customer"};if(t.startsWith("invoice."))return{event_id:n,event_type:t,created_at:i,customer_id:e.customer,invoice_id:e.id,invoice_status:e.status,currency:e.currency,amount_cents:e.amount_due,subscription_id:e.subscription||void 0,payment_status:e.paid?"succeeded":"pending",object_type:"invoice"};if(t.startsWith("charge."))return{event_id:n,event_type:t,created_at:i,customer_id:e.customer,charge_id:e.id,currency:e.currency,amount_cents:e.amount,payment_status:e.status,invoice_id:e.invoice||void 0,object_type:"charge"};if(t.startsWith("payment_intent."))return{event_id:n,event_type:t,created_at:i,customer_id:e.customer,currency:e.currency,amount_cents:e.amount,payment_status:e.status,object_type:"payment_intent"};return null}catch(e){return console.error("Error parsing Stripe webhook:",e),null}}(e);if(!n)return console.log(`Skipping Stripe event type: ${e.type}`),{eventId:null};n.email&&(r=n.email);let i=null;if(n.customer_id&&r?i=await (0,g.findOrCreatePerson)({identity_type:"email",identity_value:r,source:"stripe",email:r}):n.customer_id&&(i=await (0,g.findOrCreatePerson)({identity_type:"user_id",identity_value:n.customer_id,source:"stripe"})),!i)return console.warn(`Could not find or create person for Stripe event: ${n.event_type}`),{eventId:null};if("subscription"===n.object_type&&n.subscription_id){if(n.event_type===f.CUSTOMER_SUBSCRIPTION_CREATED||n.event_type===f.CUSTOMER_SUBSCRIPTION_UPDATED){let e;try{await (0,g.updateSubscription)(n.subscription_id,{status:n.subscription_status,amount_cents:n.amount_cents||0,interval:n.interval||"month",current_period_start:new Date(n.current_period_start).toISOString(),current_period_end:new Date(n.current_period_end).toISOString(),canceled_at:n.canceled_at?new Date(n.canceled_at).toISOString():void 0,ended_at:n.ended_at?new Date(n.ended_at).toISOString():void 0}),e=await (0,g.getSubscription)(n.subscription_id)}catch{n.event_type===f.CUSTOMER_SUBSCRIPTION_CREATED&&(e=await (0,g.createSubscription)({person_id:i.id,stripe_subscription_id:n.subscription_id,stripe_customer_id:n.customer_id,plan_id:n.plan_id||"unknown",plan_name:n.plan_name,status:n.subscription_status||"active",amount_cents:n.amount_cents||0,currency:n.currency||"usd",interval:n.interval||"month",current_period_start:new Date(n.current_period_start).toISOString(),current_period_end:new Date(n.current_period_end).toISOString(),trial_start:n.trial_start?new Date(n.trial_start).toISOString():void 0,trial_end:n.trial_end?new Date(n.trial_end).toISOString():void 0,canceled_at:n.canceled_at?new Date(n.canceled_at).toISOString():void 0}))}if(e)try{let t=await w(e.id);await I(e,t||void 0)}catch(e){console.error("Failed to create subscription snapshot:",e)}}else if(n.event_type===f.CUSTOMER_SUBSCRIPTION_DELETED){await (0,g.updateSubscription)(n.subscription_id,{status:"canceled",canceled_at:new Date().toISOString(),ended_at:new Date().toISOString()});try{let e=await (0,g.getSubscription)(n.subscription_id);if(e){let t=await w(e.id);await I(e,t||void 0)}}catch(e){console.error("Failed to create subscription snapshot:",e)}}}let a=await (0,g.createEvent)({person_id:i.id,event_name:`stripe.${n.event_type}`,event_type:(t=n.event_type)===f.CUSTOMER_SUBSCRIPTION_CREATED||t===f.INVOICE_PAYMENT_SUCCEEDED||t===f.CHARGE_SUCCEEDED||t===f.INVOICE_PAYMENT_FAILED||t===f.CHARGE_FAILED?"monetization":"retention",event_source:"stripe",event_id:n.event_id,event_time:new Date(1e3*n.created_at).toISOString(),subscription_id:n.subscription_id,subscription_status:n.subscription_status,plan_id:n.plan_id,mrr_cents:n.amount_cents?"year"===n.interval?Math.round(n.amount_cents/12):n.amount_cents:0,revenue_cents:n.amount_cents,currency:n.currency||"usd",properties:{invoice_id:n.invoice_id,charge_id:n.charge_id,customer_id:n.customer_id,payment_status:n.payment_status,interval:n.interval,error_message:n.error_message}});return console.log(`Stored Stripe event: ${n.event_type} for customer ${n.customer_id}`),{eventId:a.id,subscriptionId:n.subscription_id}}catch(e){return console.error("Error processing Stripe webhook:",e),{eventId:null}}}async function O(e){try{let t,r=process.env.STRIPE_WEBHOOK_SECRET;if(!r)return console.error("STRIPE_WEBHOOK_SECRET is not configured"),R.NextResponse.json({error:"Webhook secret not configured"},{status:500});let n=await e.text(),i=e.headers.get("stripe-signature");if(!i)return console.warn("Missing Stripe-Signature header in webhook request"),R.NextResponse.json({error:"Missing webhook signature"},{status:400});if(!function(e,t,r,n=300){try{let i=t.split(","),a=null,s=[];for(let e of i){let[t,r]=e.split("=",2);"t"===t?a=r:"v1"===t&&s.push(r)}if(!a||0===s.length)return console.warn("Invalid Stripe-Signature format"),!1;let o=Math.floor(Date.now()/1e3),c=parseInt(a,10);if(isNaN(c)||Math.abs(o-c)>n)return console.warn(`Webhook timestamp outside tolerance window. Now: ${o}, ts: ${c}, diff: ${Math.abs(o-c)}s`),!1;let u="string"==typeof e?e:e.toString("utf-8"),d=`${a}.${u}`,_=y.default.createHmac("sha256",r).update(d).digest("hex");for(let e of s)try{if(y.default.timingSafeEqual(Buffer.from(e),Buffer.from(_)))return!0}catch{continue}return console.warn("Stripe webhook signature mismatch"),!1}catch(e){return console.error("Error verifying Stripe webhook signature:",e),!1}}(n,i,r))return console.warn("Invalid Stripe webhook signature"),R.NextResponse.json({error:"Invalid webhook signature"},{status:401});try{t=JSON.parse(n)}catch(e){return console.error("Failed to parse webhook payload:",e),R.NextResponse.json({error:"Invalid JSON payload"},{status:400})}console.log(`Received Stripe webhook: ${t.type}`,{event_id:t.id,created:new Date(1e3*t.created).toISOString(),livemode:t.livemode});let a=await T(t);if(a.eventId)return R.NextResponse.json({success:!0,event_id:a.eventId,subscription_id:a.subscriptionId,message:"Webhook processed successfully"});return R.NextResponse.json({success:!0,message:"Webhook received but not processed"})}catch(e){return console.error("Error handling Stripe webhook:",e),R.NextResponse.json({error:"Internal server error"},{status:500})}}async function N(){return R.NextResponse.json({status:"ok",message:"Stripe webhook endpoint is active",configured:!!process.env.STRIPE_WEBHOOK_SECRET})}e.s(["GET",()=>N,"POST",()=>O],28562);var D=e.i(28562);let A=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:D}),{workAsyncStorage:P,workUnitAsyncStorage:U,serverHooks:x}=A;function M(){return(0,i.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:U})}async function k(e,t,r){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/webhooks/stripe/route";i=i.replace(/\/index$/,"")||"/";let R=await A.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:f,nextConfig:g,parsedUrl:b,isDraftMode:C,prerenderManifest:w,routerServerContext:I,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:N,clientReferenceManifest:D,serverActionsManifest:P}=R,U=(0,c.normalizeAppPath)(i),x=!!(w.dynamicRoutes[U]||w.routes[N]),M=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,b,!1):t.end("This page could not be found"),null);if(x&&!C){let e=!!w.routes[N],t=w.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await M();throw new h.NoFallbackError}}let k=null;!x||A.isDev||C||(k="/index"===(k=N)?"/":k);let H=!0===A.isDev||!x,$=x&&!H;P&&D&&(0,o.setManifestsSingleton)({page:i,clientReferenceManifest:D,serverActionsManifest:P});let j=e.method||"GET",B=(0,s.getTracer)(),q=B.getActiveScopeSpan(),F={params:f,prerenderManifest:w,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,i)=>A.onRequestError(e,t,n,i,I)},sharedContext:{buildId:y}},L=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>A.handle(G,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==_.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${i}`)}),c=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var s,u;let d=async({previousCacheEntry:n})=>{try{if(!c&&T&&O&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=F.renderOpts.fetchMetrics;let s=F.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let u=F.renderOpts.collectedTags;if(!x)return await (0,p.sendResponse)(L,W,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[v.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:S.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:T})},!1,I),t}},_=await A.handleResponse({req:e,nextConfig:g,cacheKey:k,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:w,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:c});if(!x)return null;if((null==_||null==(s=_.value)?void 0:s.kind)!==S.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==_||null==(u=_.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",T?"REVALIDATED":_.isMiss?"MISS":_.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,E.fromNodeOutgoingHttpHeaders)(_.value.headers);return c&&x||h.delete(v.NEXT_CACHE_TAGS_HEADER),!_.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(_.cacheControl)),await (0,p.sendResponse)(L,W,new Response(_.value.body,{headers:h,status:_.value.status||200})),null};q?await u(q):await B.withPropagatedContext(e.headers,()=>B.trace(_.BaseServerSpan.handleRequest,{spanName:`${j} ${i}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},u))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:T})},!1,I),x)throw t;return await (0,p.sendResponse)(L,W,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>M,"routeModule",()=>A,"serverHooks",()=>x,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>U],27890)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_79e079d0.js.map